<style>
    .tag-title{
        margin-left: 40%;
        font-size :20px;
        margin-top: -20px;
        background-color: white;
        position: fixed;
    }
</style>
<div class="layui-fluid layui-anim febs-anim" id="fbs-recent" lay-title="近效期QFF">
    <div class="layui-row febs-container">
        <div class="layui-col-md12">
            <div class="layui-card">
                <div class="layui-card-body febs-table-full">
                    <form class="layui-form layui-table-form" lay-filter="recent-table-form" style="margin-top: 15px" >
                        <div class="layui-row">
                            <div class="layui-col-md12">
                                <div class="layui-form-item" style="margin-left: 15px;">
                                    <div class="layui-inline">
                                        <label class="layui-form-label"  style="border-right: 1px solid white;">物料号</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="kMater" autocomplete="off" class="layui-input" placeholder="请输入康德乐物料号">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label"  style="border-right: 1px solid white;">批号</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="batch" autocomplete="off" class="layui-input" placeholder="请输入批号">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label"  style="border-right: 1px solid white;">日期区间</label>
                                        <div class="layui-input-inline">
                                            <input type="text" name="searchTime" id="recent-searchTime" class="layui-input" placeholder="请选择时间">
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label"  style="border-right: 1px solid white;">状态</label>
                                        <div class="layui-input-inline">
                                            <select name="status">
                                                <option value="">全部</option>
                                                <option value="1">新建</option>
                                                <option value="2">审核中</option>
                                                <option value="3">完结</option>
                                                <option value="4">异常</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="layui-inline">
                                        <label class="layui-form-label" style="border-right: 1px solid white;">筛选</label>
                                        <div class="layui-input-inline" style="border-bottom: white">
                                            <select name="att">
                                                <option value="">全部</option>
                                                <option value="1">可审核</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div id="recent-check" style="border-left: 1px solid white;border-top: 1px solid white;height: 40px;float: right;margin-right: 3%">
                                        <!--<div id="recent-check" class="layui-form-item" style="border-left: 1px solid white;border-top: 1px solid white;height: 40px;">-->
                                            <div class="layui-btn layui-btn-normal layui-btn-sm"  id="recent-query" >
                                                <i class="layui-icon">&#xe848;</i>
                                            </div>
                                            <div class="layui-btn layui-btn-danger layui-btn-sm " id="recent-reset" >
                                                <i class="layui-icon">&#xe79b;</i>
                                            </div>
                                        <!--</div>-->
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="layui-collapse" lay-accordion lay-filter="recent-navi" style="border:0px solid white">
                            <div class="layui-colla-item" >
                                <div class="layui-colla-content" style="border:0px solid white">
                                    <div class="layui-form-item">
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">罗氏物料号</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="rMater"  maxlength="50" autocomplete="off" class="layui-input"  placeholder="请输入罗氏物料号" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">产品名称</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="name" maxlength="50" autocomplete="off" class="layui-input "  placeholder="请输入产品名称" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">有效期</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="recent-useLife" name="useLife"  maxlength="50" autocomplete="off" class="layui-input"  placeholder="请输入有效期" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">SAP 批次</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="sapBatch" maxlength="50" autocomplete="off" class="layui-input "  placeholder="请输入SAP 批次" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">工厂</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="factory" maxlength="50" autocomplete="off" class="layui-input"  placeholder="请输入工厂" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">库位</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="wareHouse"  maxlength="50" autocomplete="off" class="layui-input"  placeholder="请输入库位" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">数量</label>
                                            <div class="layui-input-inline">
                                                <input type="text" name="number" maxlength="50" autocomplete="off" class="layui-input "  placeholder="请输入数量" >
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">罗氏处理意见</label>
                                            <div class="layui-input-inline" >
                                                <input type="text" name="rConf"   lay-verify="required" maxlength="50" autocomplete="off" list="recent_search_rConf" class="layui-input" placeholder="请输入" >
                                                <datalist id="recent_search_rConf" style="display:none;"></datalist>
                                            </div>
                                        </div>
                                        <div class="layui-inline">
                                            <label class="layui-form-label" style="border-right: 1px solid white;">回复日期</label>
                                            <div class="layui-input-inline">
                                                <input type="text" id="recent-repDate" name="repDate"  autocomplete="off" class="layui-input" placeholder="请选择时间">
                                            </div>
                                        </div>
                                    </div>
                                    <div class="layui-form-item ">
                                        <div style="float: right;margin-right: 3%" >
                                            <div class="layui-btn layui-btn-normal layui-btn-sm" id="recent-queryBtn" >
                                                <i class="layui-icon">&#xe848;</i>
                                            </div>
                                            <div class="layui-btn layui-btn-danger layui-btn-sm" id="recent-cleanBtn" >
                                                <i class="layui-icon">&#xe79b;</i>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                                <div id="recent-tag" class="layui-colla-title" style="background-color: white;height:0px;width: 0px" >
                                    <i class="layui-icon tag-title" >&#xe61a;</i>
                                </div>
                            </div>
                        </div>
                    </form>
                    <table lay-filter="recentTable" lay-data="{id: 'recentTable'}"></table>
                </div>
            </div>
        </div>
    </div>
</div>
<script type="text/html" id="recent-status">
    {{# if(d.status == '1'){d.status = '新建'}}
    <span class="layui-badge febs-tag-volcano">{{ d.status }}</span>
    {{# } else if(d.status == '2'){d.status = '审核中'}}
    <span class="layui-badge febs-tag-blue">{{ d.status }}</span>
    {{# } else if(d.status == '3'){d.status = '完结'}}
    <span class="layui-badge febs-tag-green">{{ d.status }}</span>
    {{# } else if(d.status == '4'){d.status = '删除'}}
    <span class="layui-badge febs-tag-orange">{{ d.status }}</span>
    {{# } }}
</script>
<script type="text/html" id="recent-option">

    <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="recent-detail" shiro:hasPermission="recent:view">查看</a>
    {{#  if(d.status != '3'&& d.isAllow == '1'){}}
    <a class="layui-btn layui-btn-xs" lay-event="recent-edit"  shiro:hasPermission="recent:audit">审核</a>
    {{#  if(d.repDate != ''&&d.repDate != null){}}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="recent-alter"  shiro:hasPermission="recent:alter ">修改</a>
    {{#}}}
    {{#}}}
    {{#  if(d.status != '3'){}}
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="recent-del" shiro:hasPermission="recent:del">删除</a>
    {{#}}}

</script>
<script type="text/html" id="recent-toolbarCheck">
    <div class="layui-btn-container">
        <button class="layui-btn  layui-btn-sm layui-btn-success" lay-event="template-download"  shiro:hasPermission="recent:template" >
            <i class="layui-icon">&#xe82a;</i> 模板下载
        </button>
        <button class="layui-btn layui-btn-sm " style="background-color: #87e8de;"   lay-event="recent-upload" id="recent-upload" shiro:hasPermission="recent:import">
            <i class="layui-icon">&#xe7aa;</i> 导入Excel
        </button>
        <button class="layui-btn layui-btn-sm" lay-event="recent-download" shiro:hasPermission="recent:down">
            <i class="layui-icon">&#xe7a8;</i> 导出Excel
        </button>
    </div>
</script>
<script data-th-inline="none" type="text/javascript">
    layui.use(['jquery', 'laydate', 'form', 'table', 'febs','upload','element','layer'], function () {
        var $ = layui.jquery,
            element = layui.element,
            laydate = layui.laydate,
            layer = layui.layer,
            upload = layui.upload,
            febs = layui.febs,
            form = layui.form,
            table = layui.table,
            $view = $('#fbs-recent'),
            $query = $view.find('#recent-query'),
            $reset = $view.find('#recent-reset'),
            $queryBtn = $view.find('#recent-queryBtn'),
            $cleanBtn = $view.find('#recent-cleanBtn'),
            $searchForm = $view.find('form'),
            tableIns;

        var to = {time:new Date()};
        var rConf ="罗氏QA处理意见";


        form.render();
        element.render('collapse');

        initTable();

        laydate.render({
            elem: '#recent-searchTime'
            ,range: true
        });
        laydate.render({
            elem: '#recent-useLife'
            ,trigger: 'click'
            ,btns: ['clear']
        });
        laydate.render({
            elem: '#recent-repDate'
            ,trigger: 'click'
            ,btns: ['clear']
        });

        element.on('collapse(recent-navi)', function(data){
            if(data.show == true){
                $('#recent-tag').html('');
                $('#recent-tag').append('<i  class="layui-icon tag-title">&#xe619;</i>');
                $('#recent-check').attr("style","display:none;")
            }else if(data.show == false){
                $('#recent-tag').html('');
                $('#recent-tag').append('<i  class="layui-icon tag-title" >&#xe61a;</i>');
                $('#recent-check').attr("style","border-left: 1px solid white;border-top: 1px solid white;height: 40px;float: right;margin-right: 3%;display:inline");
            }
        });


        function initTable() {
            tableIns = febs.table.init({
                id: '#recentTable',
                elem: $view.find('table'),
                height: 455,
                id: 'recentTable',
                url: ctx + 'recent/list',
                toolbar: '#recent-toolbarCheck',
                defaultToolbar: ['filter','print'],
                where:{
                    time:new Date()
                },
                cols: [[
                    {field: 'kMater', title: '康德乐物料号',align:'center',minWidth: 120},
                    {field: 'rMater', title: '罗氏物料号',align:'center',minWidth: 120},
                    {field: 'name', title: '产品名称',align:'center',minWidth: 120},
                    {field: 'useLife', title: '有效期',align:'center',minWidth: 120},
                    {field: 'batch', title: '批号',align:'center',minWidth: 120},
                    {field: 'sapBatch', title: 'SAP 批次',align:'center',minWidth: 120},
                    {field: 'factory', title: '工厂',align:'center',minWidth: 120},
                    {field: 'wareHouse', title: '库位',align:'center',minWidth: 120},
                    {title: '处理阶段', templet: '#recent-status',align:'center',minWidth: 120},
                    {title: '操作', toolbar: '#recent-option',align:'center',width: 200}
                ]],
                done:function (res,curr,count) {
                    $(".layui-table-header .layui-table thead tr th").css("border","1px solid white").css("background-color","#E8E8E8");
                    $(".layui-table-body .layui-table-col-special .layui-table-cell .layui-btn").css("float","left").css("margin-top","4px");

                    var tableId= this.id;
                    var tableElem = this.elem;
                    var tableViewElem = tableElem.next();
                    upload.render({
                        elem:tableViewElem.find('#recent-upload')
                        ,url: ctx+'file/resolver'
                        ,exts: 'xlsx|xls'
                        ,multiple: false
                        ,auto: true
                        ,size: 1024*5 //kb
                        ,before: function(obj){
                            layer.load();
                        }
                        ,done:function (res) {
                            if(res.code ===200){
                                layer.closeAll('loading');
                                febs.alert.success('操作成功');
                                $query.click();
                            }else if(res.code ===500){
                                layer.closeAll('loading');
                                febs.alert.success('解析失败');
                            }
                        }
                    })
                }
            });
        }



        $query.on('click', function () {
            tableIns.reload({where: getQueryParams(), page: {curr: 1}});
        });
        $queryBtn.on('click',function () {
            tableIns.reload({where: getQueryParams(), page: {curr: 1}});
        });
        $cleanBtn.on('click',function () {
            $searchForm[0].reset();
            tableIns.reload({where: getQueryParams(), page: {curr: 1}});
        });
        $reset.on('click', function () {
            $searchForm[0].reset();
            tableIns.reload({where: getQueryParams(), page: {curr: 1}});
        });


        table.on('toolbar(recentTable)', function(obj){
            var layEvent = obj.event;
            if (layEvent === 'recent-download') {
                var params =getQueryParams();
                febs.download(ctx + 'recent/excel',params, '近效期QFF.xlsx');
            }
            if (layEvent === 'template-download'){
                febs.download(ctx + 'file/template', null, 'Excel导入模板.xlsx');
            }

        });


        function isNumber(value) {
            var patrn = /^(-)?\d+(\.\d+)?$/;
            if (patrn.exec(value) === null || value === "") {
                return false
            } else {
                return true
            }
        }


        table.on('tool(recentTable)', function (obj) {
            var data = obj.data,
                layEvent = obj.event;
            if (layEvent === 'recent-detail') {
                febs.modal.open('具体信息', 'system/qff/recent/recentShow/' + data.id, {
                    area:  [$(window).width() <= 750 ? '90%' : '70%',$(window).width() <= 750 ? '90%' : '70%']
                });
            }
            if (layEvent === 'recent-edit') {
                febs.modal.open('审核', 'system/qff/recent/recentAudit/' + data.id, {
                    area:  [$(window).width() <= 750 ? '90%' : '70%',$(window).width() <= 750 ? '90%' : '70%']
                });
            }
            if (layEvent === 'recent-del') {
                febs.modal.confirm('删除该条数据','确定删除该条数据？', function () {
                    delRecent(data.id);
                });
            }
            if (layEvent === 'recent-alter') {
                febs.modal.open('修改', 'system/qff/recent/recentAlter/' + data.id+"/"+"1", {
                    area:  [$(window).width() <= 750 ? '90%' : '70%',$(window).width() <= 750 ? '90%' : '70%']
                });
            }

        });


        function delRecent(id) {
            $.get(ctx + 'recent/deleteRecent/' + id, to, function () {
                febs.alert.success('操作成功');
                $query.click();
            });

        }

        table.on('sort(recentTable)', function (obj) {
            tableIns.reload({
                where: $.extend(getQueryParams())
            });
        });

        $.get(ctx +"opinion/getOpinion/"+rConf,to,function(res){
            var data = res.data;
            $.each(data,function(index,item){
                $("#recent_search_rConf").append('<option value="'+item.name+'"></option>')
            });
        });



        function getQueryParams() {
            var createTimeFrom,
                createTimeTo,
                createTime = $searchForm.find('input[name="searchTime"]').val();
            if (createTime) {
                createTimeFrom = createTime.split(' - ')[0];
                createTimeTo = createTime.split(' - ')[1];
            }
            return {
                startTime: createTimeFrom,
                endTime: createTimeTo,
                kMater: $searchForm.find('input[name="kMater"]').val().trim(),
                batch: $searchForm.find('input[name="batch"]').val().trim(),
                rMater: $searchForm.find('input[name="rMater"]').val().trim(),
                name: $searchForm.find('input[name="name"]').val().trim(),
                useLife: $searchForm.find('input[name="useLife"]').val().trim(),
                sapBatch: $searchForm.find('input[name="sapBatch"]').val().trim(),
                factory: $searchForm.find('input[name="factory"]').val().trim(),
                wareHouse: $searchForm.find('input[name="wareHouse"]').val().trim(),
                number: $searchForm.find('input[name="number"]').val().trim(),
                rConf: $searchForm.find('input[name="rConf"]').val().trim(),
                repDate: $searchForm.find('input[name="repDate"]').val().trim(),
                status: $searchForm.find("select[name='status']").val(),
                att: $searchForm.find("select[name='att']").val(),
                invalidate_ie_cache: new Date()
            };
        }
    })
</script>